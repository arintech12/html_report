name: run-code-coverage
on:
  push:
    branches: ["test-2"]
  workflow_dispatch:
permissions:
  contents: write
jobs:
  run-code-coverage:
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo
        uses: actions/checkout@v4
      
      - name: setup python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: install python packages
        run: |
          python -m pip install --upgrade pip
          pip install coverage
          pip install urllib3
      
      - name: run coverage
        run: |
          coverage run -m test
          coverage report --format=markdown > coverage.md
          coverage html --omit='.venv/*'
      
      - name: add coverage to summary
        run: |
          # Calculate previous run numbers and URLs
          CURRENT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          PREV1_URL=""
          PREV2_URL=""
          PREV3_URL=""
          PREV4_URL=""
          
          if [ ${{ github.run_number }} -gt 1 ]; then
            PREV1_NUM=$((${{ github.run_number }} - 1))
            PREV1_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id - 1 }}"
          fi
          if [ ${{ github.run_number }} -gt 2 ]; then
            PREV2_NUM=$((${{ github.run_number }} - 2))
            PREV2_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id - 2 }}"
          fi
          if [ ${{ github.run_number }} -gt 3 ]; then
            PREV3_NUM=$((${{ github.run_number }} - 3))
            PREV3_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id - 3 }}"
          fi
          if [ ${{ github.run_number }} -gt 4 ]; then
            PREV4_NUM=$((${{ github.run_number }} - 4))
            PREV4_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id - 4 }}"
          fi
          
          echo "## 📊 Coverage Report - Run #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat coverage.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 📁 HTML Coverage Reports (Last 5 Runs):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Run # | Status | Download Link |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------------|" >> $GITHUB_STEP_SUMMARY
          echo "| **#${{ github.run_number }}** | ✅ **Current** | [coverage-report-run-${{ github.run_number }}]($CURRENT_URL) |" >> $GITHUB_STEP_SUMMARY
          
          # Add previous runs if they exist
          if [ -n "$PREV1_URL" ]; then
            echo "| #$PREV1_NUM | ⏳ Previous | [coverage-report-run-$PREV1_NUM]($PREV1_URL) |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "$PREV2_URL" ]; then
            echo "| #$PREV2_NUM | ⏳ Previous | [coverage-report-run-$PREV2_NUM]($PREV2_URL) |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "$PREV3_URL" ]; then
            echo "| #$PREV3_NUM | ⏳ Previous | [coverage-report-run-$PREV3_NUM]($PREV3_URL) |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "$PREV4_URL" ]; then
            echo "| #$PREV4_NUM | ⏳ Previous | [coverage-report-run-$PREV4_NUM]($PREV4_URL) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "💡 **How to access:** Click on any run number above → Scroll to Artifacts section → Download the coverage report" >> $GITHUB_STEP_SUMMARY
      
      - name: create timestamped report
        run: |
          mkdir -p reports/run-${{ github.run_number }}
          cp -r htmlcov/* reports/run-${{ github.run_number }}/
      
      - name: upload current report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-run-${{ github.run_number }}
          path: htmlcov/
          retention-days: 90
      
      - name: checkout existing reports
        uses: actions/checkout@v4
        with:
          ref: coverage-reports
          path: existing-reports
        continue-on-error: true
      
      - name: merge with existing reports
        run: |
          mkdir -p coverage-reports
          
          if [ -d "existing-reports" ]; then
            cp -r existing-reports/* coverage-reports/ 2>/dev/null || true
          fi
          
          mkdir -p coverage-reports/run-${{ github.run_number }}
          cp -r htmlcov/* coverage-reports/run-${{ github.run_number }}/
          
          cd coverage-reports
          ls -d run-* | sort -V | head -n -5 | xargs -r rm -rf
          
          echo "<!DOCTYPE html>" > index.html
          echo "<html>" >> index.html
          echo "<head><title>Coverage Reports Archive</title></head>" >> index.html
          echo "<body>" >> index.html
          echo "<h1>Coverage Reports Archive</h1>" >> index.html
          echo "<ul>" >> index.html
          for dir in $(ls -d run-* | sort -Vr); do
            run_num=$(echo $dir | sed 's/run-//')
            echo "<li><a href=\"$dir/index.html\">Run #$run_num Coverage Report</a></li>" >> index.html
          done
          echo "</ul>" >> index.html
          echo "</body>" >> index.html
          echo "</html>" >> index.html
      
      - name: upload merged reports
        uses: actions/upload-artifact@v4
        with: 
          name: coverage-reports-archive
          path: coverage-reports/
          retention-days: 90
      
      - name: deploy to coverage-reports branch
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: coverage-reports
          publish_branch: coverage-reports
          force_orphan: true
