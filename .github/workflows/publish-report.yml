name: run-code-coverage
on:
  push:
    branches: ["test-2"]
  workflow_dispatch:
permissions:
  contents: write
jobs:
  run-code-coverage:
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo
        uses: actions/checkout@v4
      
      - name: setup python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: install python packages
        run: |
          python -m pip install --upgrade pip
          pip install coverage
          pip install urllib3
      
      - name: run coverage
        run: |
          coverage run -m test
          coverage report --format=markdown > coverage.md
          coverage html --omit='.venv/*'
      
      - name: add coverage to summary
        run: |
          # Get current run URL
          CURRENT_URL="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          
          echo "## 📊 Coverage Report - Run #$GITHUB_RUN_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat coverage.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 📁 HTML Coverage Reports (Last 5 Runs):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Run # | Status | Download Link |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------------|" >> $GITHUB_STEP_SUMMARY
          echo "| **#$GITHUB_RUN_NUMBER** | ✅ **Current** | [coverage-report-run-$GITHUB_RUN_NUMBER]($CURRENT_URL) |" >> $GITHUB_STEP_SUMMARY
          
          # Add placeholders for previous runs (will be filled manually if needed)
          echo "| #$(($GITHUB_RUN_NUMBER - 1)) | ⏳ Previous | [coverage-report-run-$(($GITHUB_RUN_NUMBER - 1))]() |" >> $GITHUB_STEP_SUMMARY
          echo "| #$(($GITHUB_RUN_NUMBER - 2)) | ⏳ Previous | [coverage-report-run-$(($GITHUB_RUN_NUMBER - 2))]() |" >> $GITHUB_STEP_SUMMARY
          echo "| #$(($GITHUB_RUN_NUMBER - 3)) | ⏳ Previous | [coverage-report-run-$(($GITHUB_RUN_NUMBER - 3))]() |" >> $GITHUB_STEP_SUMMARY
          echo "| #$(($GITHUB_RUN_NUMBER - 4)) | ⏳ Previous | [coverage-report-run-$(($GITHUB_RUN_NUMBER - 4))]() |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "💡 **How to access:** Click on any run number above → Scroll to Artifacts section → Download the coverage report" >> $GITHUB_STEP_SUMMARY
          echo "Note: Links to previous runs need to be filled manually as GitHub doesn't provide a way to generate them automatically." >> $GITHUB_STEP_SUMMARY
      
      - name: create timestamped report
        run: |
          mkdir -p reports/run-$GITHUB_RUN_NUMBER
          cp -r htmlcov/* reports/run-$GITHUB_RUN_NUMBER/
      
      - name: upload current report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-run-$GITHUB_RUN_NUMBER
          path: htmlcov/
          retention-days: 90
      
      - name: checkout existing reports
        uses: actions/checkout@v4
        with:
          ref: coverage-reports
          path: existing-reports
        continue-on-error: true
      
      - name: merge with existing reports
        run: |
          mkdir -p coverage-reports
          
          if [ -d "existing-reports" ]; then
            cp -r existing-reports/* coverage-reports/ 2>/dev/null || true
          fi
          
          mkdir -p coverage-reports/run-$GITHUB_RUN_NUMBER
          cp -r htmlcov/* coverage-reports/run-$GITHUB_RUN_NUMBER/
          
          cd coverage-reports
          ls -d run-* | sort -V | head -n -5 | xargs -r rm -rf
          
          echo "<!DOCTYPE html>" > index.html
          echo "<html>" >> index.html
          echo "<head><title>Coverage Reports Archive</title></head>" >> index.html
          echo "<body>" >> index.html
          echo "<h1>Coverage Reports Archive</h1>" >> index.html
          echo "<ul>" >> index.html
          for dir in $(ls -d run-* | sort -Vr); do
            run_num=$(echo $dir | sed 's/run-//')
            echo "<li><a href=\"$dir/index.html\">Run #$run_num Coverage Report</a></li>" >> index.html
          done
          echo "</ul>" >> index.html
          echo "</body>" >> index.html
          echo "</html>" >> index.html
      
      - name: upload merged reports
        uses: actions/upload-artifact@v4
        with: 
          name: coverage-reports-archive
          path: coverage-reports/
          retention-days: 90
      
      - name: deploy to coverage-reports branch
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: coverage-reports
          publish_branch: coverage-reports
          force_orphan: true
